<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Saksham Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta http-equiv="refresh" content="3"> <style>
        .magic-wand { cursor: help; font-size: 1.2rem; }
        .row-data-box { 
            background: #f8f9fa; 
            border-radius: 4px; 
            padding: 8px; 
            font-family: monospace; 
            font-size: 0.85rem; 
            max-height: 150px; 
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold">ðŸš€ Project Saksham</h2>
            <div class="text-muted small">Job ID: {{ job.id }}</div>
        </div>
        <div>
             <a href="{{ job.original_file.url }}" class="btn btn-outline-primary btn-sm" target="_blank">View Source File</a>
            <span class="badge bg-dark ms-2">Live Pipeline</span>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card p-3 shadow-sm border-0 border-start border-4 border-primary">
                <h6 class="text-muted">Job Progress</h6>
                <h3>{{ job.progress_percentage }}%</h3>
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar" style="width: {{ job.progress_percentage }}%"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 shadow-sm border-0 border-start border-4 border-success">
                <h6 class="text-muted">Rows Completed</h6>
                <h3>{{ stats.completed }} / {{ stats.total }}</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 shadow-sm border-0 border-start border-4 border-warning">
                <h6 class="text-muted">Avg Confidence</h6>
                <h3>{{ stats.avg_conf }}%</h3>
            </div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header bg-white py-3 d-flex justify-content-between">
            <h5 class="mb-0">Data Enrichment Heatmap</h5>
            <small class="text-muted">Red = Low Confidence | Green = High Confidence</small>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="30%">Input (Extracted Text)</th>
                        <th width="40%">Enriched Data (AI + Ghost Web)</th>
                        <th width="15%">Confidence</th>
                        <th width="15%">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                    <tr class="{% if row.confidence_score < 50 and row.status == 'COMPLETED' %}table-danger{% elif row.confidence_score >= 80 %}table-success{% endif %}">
                        
                        <td>
                           <div class="text-truncate" style="max-width: 300px;" title="{{ row.raw_text }}">
                               {{ row.raw_text|default:"Processing..." }}
                           </div>
                        </td>

                        <td>
                            {% if row.status == 'COMPLETED' %}
                                <div class="row-data-box">
                                    {{ row.enriched_data }}
                                </div>
                                {% if row.is_enriched %}
                                    <span class="badge bg-primary mt-1 magic-wand" title="Data fetched from external web source">ðŸª„ Ghost Data Active</span>
                                {% endif %}
                            {% else %}
                                <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                                <span class="text-muted fst-italic ms-2">AI Thinking...</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if row.status == 'COMPLETED' %}
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold me-2">{{ row.confidence_score }}%</span>
                                    <div class="progress flex-grow-1" style="height: 6px;">
                                        <div class="progress-bar {% if row.confidence_score < 50 %}bg-danger{% elif row.confidence_score < 80 %}bg-warning{% else %}bg-success{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ row.confidence_score }}%;"></div>
                                    </div>
                                </div>
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <td>
                            <span class="badge {% if row.status == 'COMPLETED' %}bg-success{% elif row.status == 'FAILED' %}bg-danger{% else %}bg-secondary{% endif %}">
                                {{ row.status }}
                            </span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">
                            <h5>Waiting for File Processing...</h5>
                            <p>Worker script is reading the file and creating rows.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

</body>
</html>